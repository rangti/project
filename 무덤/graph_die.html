<!DOCTYPE html>
<html>
  <head>
    <title>그래프</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <style>
      .buttons-container {
        text-align: center;
        margin-bottom: 20px;
      }
      .buttons-container button {
        padding: 10px 20px;
        margin: 10px;
        border: none;
        background-color: #4e73df;
        color: #fff;
        cursor: pointer;
        border-radius: 5px;
      }
      .buttons-container button:hover {
        background-color: #2e59d9;
      }
      .chart-container {
        margin: 20px;
      }
    </style>
  </head>
  <script>
    $(document).ready(function () {
      var year_list = [2020, 2021, 2022, 2023];
      var name_tags = ["1분기", "2분기", "3분기", "4분기"];
      var labels_name = []; // labels_name 배열 초기화
      var labels_name2 = []; // labels_name 배열 초기화


      $(".buttons-container button").each(function (idx, data) {
        $(this).click(function () {
          var selectedYear = year_list[idx]; // 선택한 연도 가져오기
          labels_name = []; // labels_name 배열 초기화
          labels_name2 = []; // labels_name 배열 초기화
          for (var i = 0; i < name_tags.length; i++) {
            labels_name.push(`${selectedYear}년 지역별 ${name_tags[i]} 데이터`);
            labels_name2.push(`${selectedYear}년 총합 ${name_tags[i]} 데이터`);
          }

          $(".buttons-container button").each(function (idx, data) {
            $(this).click(function () {
              $.ajax({
                type: "get", // 타입 (get, post, put 등등)
                url: "/die_graph", // 요청할 서버url    async : true,            // 비동기화 여부 (default : true)
                data: { year: year_list[idx] },
                dataType: "json",
                success: function (data) {
                  console.log("요청 성공", data);
                  // Prepare the data for the chart
                  const labels = Object.keys(data);
                  const totalData = labels.map((label) => data[label].total);
                  const seoulData = labels.map((label) => data[label].seoul);
                  const busanData = labels.map((label) => data[label].busan);
                  const daeguData = labels.map((label) => data[label].daegu);
                  const daejeonData = labels.map(
                    (label) => data[label].daejeon
                  );
                  const gyeonggiData = labels.map(
                    (label) => data[label].gyeonggi
                  );

                  // Create the chart
                  const ctx = document
                    .getElementById("myChart")
                    .getContext("2d");
                  // Check if the chart instance exists
                  if (window.myChartInstance) {
                    window.myChartInstance.destroy();
                  }

                  window.myChartInstance = new Chart(ctx, {
                    type: "bar",
                    data: {
                      labels: labels_name,
                      datasets: [
                        {
                          label: "seoul",
                          data: seoulData,
                          backgroundColor: "rgba(0, 255, 215, 0.2)",
                          borderColor: "rgba(255, 255, 0, 1)",
                          borderWidth: 1,
                        },
                        {
                          label: "busan",
                          data: busanData,
                          backgroundColor: "rgba(0, 255, 195, 0.2)",
                          borderColor: "rgba(255, 255, 0, 1)",
                          borderWidth: 1,
                        },
                        {
                          label: "daegu",
                          data: daeguData,
                          backgroundColor: "rgba(0, 255, 175, 0.2)",
                          borderColor: "rgba(255, 255, 0, 1)",
                          borderWidth: 1,
                        },
                        {
                          label: "daejeon",
                          data: daejeonData,
                          backgroundColor: "rgba(0, 255, 155, 0.2)",
                          borderColor: "rgba(255, 255, 0, 1)",
                          borderWidth: 1,
                        },
                        {
                          label: "gyeonggi",
                          data: gyeonggiData,
                          backgroundColor: "rgba(0, 255, 255, 0.2)",
                          borderColor: "rgba(255, 255, 0, 1)",
                          borderWidth: 1,
                        },
                      ],
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true,
                        },
                      },
                    },
                  });
                  const ctxTotal = document
                    .getElementById("myChartTotal")
                    .getContext("2d");
                  if (window.myChartInstanceTotal) {
                    window.myChartInstanceTotal.destroy();
                  }
                  window.myChartInstanceTotal = new Chart(ctxTotal, {
                    type: "bar",
                    data: {
                      labels: labels_name2, // x-axis labels (dates)
                      datasets: [
                        {
                          label: "Total",
                          data: totalData,
                          backgroundColor: "rgba(255, 99, 132, 0.2)",
                          borderColor: "rgba(255, 99, 132, 1)",
                          borderWidth: 1,
                        },
                      ],
                    },
                    options: {
                      scales: {
                        y: {
                          beginAtZero: true,
                        },
                      },
                    },
                  });
                },
              });
            });
          });
        });
      });
    });
  </script>
  <body>
    <h1 style="text-align: center">그래프</h1>

    <div class="buttons-container">
      <button id="btn2020">2020년</button>

      <button id="btn2021">2021년</button>

      <button id="btn2022">2022년</button>

      <button id="btn2023">2023년</button>
    </div>

    <div class="chart-container">
      <canvas id="myChart"></canvas>
      <canvas id="myChartTotal"></canvas>
    </div>
  </body>
</html>
